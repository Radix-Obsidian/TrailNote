<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Security-Policy" content="script-src 'self'; object-src 'none'">
  <link rel="stylesheet" href="v2/tokens.css">
  <link rel="stylesheet" href="v2/layout.css">
  <link rel="stylesheet" href="v2/components.css">
  <link rel="stylesheet" href="v2/notes.css">
  <link rel="stylesheet" href="v2/mastery.css">
  <link rel="stylesheet" href="v2/agent.css">
  <link rel="stylesheet" href="v2/analytics.css">
  <link rel="stylesheet" href="v2/chat.css">
  <link rel="stylesheet" href="v2/intelligence.css">
  <title>HintHopper</title>
</head>
<body>
  
  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>
  
  <!-- Main App Container -->
  <div class="app-container">
    
    <!-- Header -->
    <header class="app-header">
      <div class="brand">
        <button class="btn-icon mobile-nav-toggle" id="mobileNavToggle" style="display: none;">
          ‚ò∞
        </button>
        <div class="brand-icon">ü§ñ</div>
        <h1 class="brand-title">
          TrailNote
          <span class="brand-version">Agent Builder</span>
        </h1>
      </div>
      <div class="header-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span id="statusText">Ready</span>
        </div>
        <button class="btn-icon review-due-pill" id="reviewDuePill" title="Concepts due for review" style="display:none; font-size: var(--font-size-xs); padding: 2px 8px; border-radius: 12px; background: var(--color-warning-light, #fef3c7); color: var(--color-warning, #d97706); border: 1px solid var(--color-warning, #d97706); font-weight: 600;">
          ‚Ü© <span id="reviewDueCount">0</span> due
        </button>
        <button class="btn-icon" id="assistantToggle" title="Toggle assistant panel">
          üí¨
        </button>
      </div>
    </header>
    
    <!-- Sidebar Navigation -->
    <aside class="app-sidebar" id="appSidebar">
      <nav>
        <div class="nav-section">
          <div class="nav-section-title">Agents</div>
          <div class="nav-item active" data-view="agent-designer">
            <span class="nav-icon">ü§ñ</span>
            <span>Agent Designer</span>
          </div>
          <div class="nav-item" data-view="agent-memory">
            <span class="nav-icon">üß†</span>
            <span>Agent Memory</span>
            <span class="nav-badge" id="memoryCount">0</span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Knowledge</div>
          <div class="nav-item" data-view="knowledge-graph">
            <span class="nav-icon">üîó</span>
            <span>Knowledge Graph</span>
          </div>
          <div class="nav-item" data-view="analytics">
            <span class="nav-icon">üìä</span>
            <span>Activity</span>
          </div>
          <div class="nav-item" data-view="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Settings</span>
          </div>
        </div>
      </nav>
      
      <!-- Intelligence Status Widget -->
      <div id="intelligenceStatus" style="margin-top: var(--space-4); padding: var(--space-3); border-radius: var(--radius-md); background: var(--color-gray-50); display:flex; flex-direction:column; gap:4px;">
        <div class="intel-stat" style="opacity:0.5;"><span class="intel-label">Intelligence</span><span class="intel-value">Loading...</span></div>
      </div>

      <!-- Quick Actions in Sidebar -->
      <div style="margin-top: auto; padding-top: var(--space-6); border-top: 1px solid var(--color-gray-200);">
        <div style="font-size: var(--font-size-xs); color: var(--color-gray-500); margin-bottom: var(--space-2); padding: 0 var(--space-3);">
          SHORTCUTS
        </div>
        <div style="font-size: var(--font-size-sm); color: var(--color-gray-600); padding: var(--space-2) var(--space-3); line-height: 1.6;">
          <div><kbd>Ctrl+Shift+N</kbd> New Note</div>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="app-main" id="appMain">
      
      <!-- Agent Designer View -->
      <div class="view-container" id="agent-designerView">
        <div class="main-header">
          <h2 class="main-title">Agent Designer</h2>
          <span class="badge badge-info">No-code agent creation</span>
        </div>
        
        <!-- Agent Designer content will be injected here -->
        <div id="agentDesignerContent">
          <div class="spinner" style="margin: var(--space-8) auto;"></div>
        </div>
      </div>
      
      <!-- Agent Memory View -->
      <div class="view-container" id="agent-memoryView" style="display: none;">
        <div class="main-header">
          <h2 class="main-title">Agent Memory</h2>
          <div class="main-actions">
            <button class="btn-secondary btn-sm" id="exportMemory">
              <span>üì§</span>
              Export
            </button>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3 class="card-title">What your agents remember</h3>
          </div>
          <div class="card-body">
            <input class="form-input" id="memorySearch" placeholder="üîç Search agent memory..." style="margin-bottom: var(--space-4);">
            <ul id="memoryList" class="list"></ul>
          </div>
        </div>
      </div>
      
      <!-- Knowledge Graph View -->
      <div class="view-container" id="knowledge-graphView" style="display: none;">
        <div class="main-header">
          <h2 class="main-title">Knowledge Graph</h2>
        </div>
        
        <!-- Knowledge graph content will be rendered here -->
        <div id="knowledgeGraphContent">
          <div class="spinner" style="margin: var(--space-8) auto;"></div>
        </div>
      </div>
      
      <!-- Agent Activity View (replaces Flashcards) -->
      
      <!-- Agent Activity View -->
      <div class="view-container" id="analyticsView" style="display: none;">
        <div class="main-header">
          <h2 class="main-title">Agent Activity</h2>
        </div>
        
        <!-- Activity content will be rendered here -->
        <div id="analyticsContent">
          <div class="spinner" style="margin: var(--space-8) auto;"></div>
        </div>
      </div>
      
      <!-- Settings View -->
      <div class="view-container" id="settingsView" style="display: none;">
        <div class="main-header">
          <h2 class="main-title">Settings</h2>
        </div>
        
        <div class="content-card">
          <div class="card-header">
            <h3 class="card-title">LLM Provider</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Provider</label>
              <select class="form-select" id="llmProvider">
                <option value="openai" selected>OpenAI</option>
                <option value="groq">Groq (Fast & Free)</option>
                <option value="ollama">Ollama (Local/Cloud)</option>
              </select>
            </div>
            
            <div id="openaiSettings">
              <div class="form-group">
                <label class="form-label" for="apiKey">OpenAI API Key</label>
                <input class="form-input" id="apiKey" type="password" placeholder="sk-...">
              </div>
              <div class="form-group">
                <label class="form-label">Model</label>
                <select class="form-select" id="modelSelect">
                  <option value="gpt-4o-mini" selected>gpt-4o-mini (default)</option>
                  <option value="gpt-4o">gpt-4o</option>
                  <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                  <option value="gpt-4.1">gpt-4.1</option>
                  <option value="o4-mini">o4-mini</option>
                  <option value="o4">o4</option>
                </select>
              </div>
            </div>
            
            <div id="groqSettings" style="display:none;">
              <div class="form-group">
                <label class="form-label" for="groqApiKey">Groq API Key</label>
                <input class="form-input" id="groqApiKey" type="password" placeholder="gsk_...">
                <small class="form-hint">Get your free API key at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></small>
              </div>
              <div class="form-group">
                <label class="form-label">Model</label>
                <select class="form-select" id="groqModel">
                  <option value="llama-3.1-8b-instant" selected>llama-3.1-8b-instant (fast, free)</option>
                  <option value="llama-3.3-70b-versatile">llama-3.3-70b-versatile (powerful)</option>
                  <option value="openai/gpt-oss-120b">gpt-oss-120b (most powerful)</option>
                </select>
              </div>
            </div>
            
            <div id="ollamaSettings" style="display:none;">
              <div class="form-group">
                <label class="form-label" for="ollamaUrl">Ollama URL</label>
                <input class="form-input" id="ollamaUrl" type="text" placeholder="http://localhost:11434" value="http://localhost:11434">
              </div>
              <div class="form-group">
                <label class="form-label">Model</label>
                <div style="display:flex;gap:var(--space-2);">
                  <select class="form-select" id="ollamaModel" style="flex:1;">
                    <option value="llama2">llama2 (default)</option>
                  </select>
                  <button class="btn-secondary btn-sm" id="refreshOllamaModels">Refresh</button>
                </div>
                <small class="form-hint" id="ollamaModelStatus">Click Refresh to detect installed models</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card" style="margin-top: var(--space-4);">
          <div class="card-header">
            <h3 class="card-title">Tutor Preferences</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Hint Mode</label>
              <select class="form-select" id="hintMode">
                <option value="strict">Strict (no code solutions)</option>
                <option value="guided">Guided (partial code help)</option>
                <option value="demo">Demo (full example solutions)</option>
              </select>
            </div>
            
            <div class="form-group">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="improveBunji">
                <label class="form-check-label" for="improveBunji">
                  <span class="fw-semibold">Improve Bunji</span><br>
                  <span class="text-muted fs-sm">Help make Bunji smarter by sharing anonymous hint outcomes</span>
                  <a href="#" id="privacyDetailsLink" class="badge badge-secondary ml-2">Details</a>
                </label>
              </div>
            </div>
            
            <div class="form-checkbox">
              <input type="checkbox" id="debugMode">
              <label for="debugMode">Debug mode (show request/response)</label>
            </div>
            
            <div class="form-checkbox">
              <input type="checkbox" id="mockLLM">
              <label for="mockLLM">Mock LLM (test without API calls)</label>
            </div>
            
            <pre id="debugBox" style="display:none; max-height:200px; overflow:auto; background:var(--color-gray-900); color:var(--color-gray-100); padding:var(--space-3); border-radius:var(--radius-md); font-size:var(--font-size-xs);"></pre>
          </div>
          
          <div class="card-footer">
            <button class="btn-primary" id="savePrefs">
              <span>üíæ</span>
              Save Settings
            </button>
          </div>
        </div>
      </div>
      
    </main>
    
    <!-- Agent Chat Panel -->
    <aside class="app-assistant" id="appAssistant">
      <div class="panel-header">
        <h3 class="panel-title">Agent Chat</h3>
        <button class="btn-icon" id="closeAssistant" title="Close">
          √ó
        </button>
      </div>
      <div class="panel-content" id="chatContainer">
        <!-- Chat interface will be injected here -->
      </div>
    </aside>
    
  </div>
  
  <!-- Privacy Details Modal -->
  <div class="modal" id="privacyDetailsModal">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Privacy & Data Collection</h3>
        <button class="modal-close" id="closePrivacyModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h4 class="mb-2">When you enable "Improve Bunji":</h4>
          <p>We collect anonymous data to improve hint effectiveness:</p>
          <ul>
            <li><strong>Collected:</strong> Anonymized test fingerprints (never your full code), concept identifiers, time between hint and pass/fail</li>
            <li><strong>Never collected:</strong> Your code, personal information, or browsing history</li>
            <li><strong>Benefits:</strong> Bunji gets better at giving helpful hints for common challenges</li>
          </ul>
        </div>
        
        <div class="mb-4">
          <h4 class="mb-2">Privacy-first approach:</h4>
          <ul>
            <li>All data is anonymous and aggregated</li>
            <li>Strictly opt-in (off by default)</li> 
            <li>You can delete your data anytime</li>
            <li>You can see what was collected in the "Privacy receipt"</li>
          </ul>
        </div>
        
        <div class="alert alert-info">
          <span class="alert-icon">‚ÑπÔ∏è</span>
          <div class="alert-content">
            <div class="alert-title">Why this matters</div>
            <div class="alert-message">Your feedback helps us build a dataset of "what hints actually help students pass challenges" - making Bunji more effective for everyone!</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" id="confirmPrivacyDetails">Got it</button>
      </div>
    </div>
  </div>
  
  <script type="module" src="panel-v2.js"></script>
  <script src="../lib/storage.js" type="module"></script>
  <script src="../lib/tokens.js" type="module"></script>
  <script src="../lib/utils.js" type="module"></script>
  <script src="../lib/outcome-tracker.js" type="module"></script>
  <script src="../lib/agent-builder.js" type="module"></script>
  <script src="../lib/agent-executor.js" type="module"></script>
  <script src="../lib/action-definitions.js" type="module"></script>
  <script src="../lib/agent-templates.js" type="module"></script>
  <script src="v2/agent-designer.js" type="module"></script>
</body>
</html>
